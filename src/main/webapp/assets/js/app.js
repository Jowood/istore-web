/**
 * @name			书库 
 * @namespace		DEMO.EBOOK
 * @author			Chappell Qu <chappell(dot)wat(at)gmail(dot)com>
 * @version			0.0.1
 */
(function(s,t,a,h,l){var f=h.namespace("DEMO.EBOOK");f.CFG={CGI:"./cgi.php",NAME:"eBook Shelf",WIDTH:418,HEIGHT:498,MAX_PG:5,PER_PG:16,STACK_WIDTH:380};h.extend(a.REF,{$shelfContainer:h("#shelf"),$bookContainer:h("#book"),$overlayContainer:h("#overlay"),$shelfPagination:h("#shelf-pagination"),$stackContainer:h("#stack"),$stackWrap:h("#stack-wrap"),$bookContent:h("#content"),$bookPageNum:h("#book-page-num")});h.ajaxSetup({type:"GET",url:f.CFG.CGI,dataType:"json",timeout:5E3});a.REF.$overlayContainer.bind("ajaxStart",
function(){a.REF.$overlayContainer.removeClass(a.CLS.transparent)}).bind("ajaxStop",function(){a.REF.$overlayContainer.addClass(a.CLS.transparent)});var o=function(){var d=true;h.ajax({data:{act:"init"},success:function(b){if(!(l===b||0!==b.retcode)){var e=b.result.total_pg;if(0!==e){b=[];for(var c=0;c<f.CFG.MAX_PG;c++)b.push('<a href="###" title="\u7b2c {page} \u9875" data-pg="{page}" data-act="shelf-nav" data-loaded="{loaded}">{page}</a>'.replace(/{(\w+)}/g,function(i,n){var j="";switch(n){case "page":j=
c+1;break;case "loaded":j=a.ENV.IS_IE6?"false":c>=e;break}return j.toString()}));if(0!==b.length){a.REF.$shelfPagination.html(b.join(""));b=[];c=0;for(var g=f.CFG.MAX_PG;c<g;c++)b.push("<ul></ul>");a.REF.$stackWrap.html(b.join(""));f.CFG.STACK_WIDTH=parseInt(a.REF.$stackWrap.css("width"),10);a.REF.$stackWrap.css("width",f.CFG.STACK_WIDTH*f.CFG.MAX_PG);d=false}}}},error:function(){},complete:function(){d?alert("\u8bfb\u53d6\u51fa\u9519"):m()}})},m=function(d){if(d){d=parseInt(d,10);if(isNaN(d)||0>=
d||f.CFG.MAX_PG<d)return}else d=1;var b=a.REF.$shelfPagination.find('[data-pg="'+d+'"]:first');if(0!==b.length)if("true"!==b.attr("data-loaded"))p(d);else{a.REF.$shelfPagination.find(".selected").removeClass("selected");b.addClass("selected");a.REF.$stackWrap.animate({marginLeft:(1-d)*f.CFG.STACK_WIDTH},300)}},p=function(d){var b=true;h.ajax({data:{act:"list",pg:d},success:function(e){if(!(l===e||0!==e.retcode)){var c=e.result;e=[];for(var g=0,i=a.ENV.IS_IE6?f.CFG.PER_PG:Math.min(c.length,f.CFG.PER_PG);g<
i;g++)e.push(g in c?'<li><a href="###" title="{name}" data-idx="{idx}" data-act="open-book"><span{icon}><img src="./assets/img/clear.gif" /></span></a></li>'.replace(/{(\w+)}/g,function(n,j){var k="";switch(j){case "idx":k=(d-1)*f.CFG.PER_PG+g+1;break;case "name":k=c[g].name;break;case "icon":if("icon"in c[g])k=' style="background-image:url('+c[g].icon+')"';break}return k.toString()}):"<li></li>");a.REF.$stackWrap.find("ul:eq("+(d-1)+")").addClass(a.CLS.clearfix).html(e.join(""));a.REF.$shelfPagination.find('[data-pg="'+
d+'"]:first').attr("data-loaded","true");m(d);b=false}},error:function(){},complete:function(){b&&alert("\u8bfb\u53d6\u51fa\u9519")}})},q=function(d,b,e){var c=true;h.ajax({type:"POST",data:{act:"read",idx:d,offset:b,next:e?1:0},success:function(g){if(!(l===g||0!==g.retcode)){a.REF.$bookContent.html(g.result.content.replace(/&/g,"&#38;").replace(/</g,"&#60;").replace(/>/g,"&#62;").replace(/\r\n|\r|\n/g,"<br/>").replace(/\s/g,"&#160;"));a.REF.$bookContent.attr("data-start",g.result.start).attr("data-end",
g.result.end);var i=parseInt(a.REF.$bookContent.attr("data-pg"),10);if(!isNaN(i)){i+=e?1:-1;if(0<i){a.REF.$bookPageNum.html(i);a.REF.$bookContent.attr("data-pg",i)}}a.REF.$bookContent.attr("data-eof","eof"in g.result?"1":"");c=false}},error:function(){},complete:function(){c&&alert("\u8bfb\u53d6\u51fa\u9519")}})},r=function(){o();a.REF.$DOC.bind("click",function(b){var e=b.target;if(!(!e||1!==e.nodeType)){var c=h(e).closest("a[data-act]");if(0!==c.length){switch(c.attr("data-act")){case "external-shelf":try{alloy.system.openURL({url:c[0].href})}catch(g){return}break;
case "return-shelf":a.REF.$bookContainer.addClass(a.CLS.transparent);break;case "shelf-nav":m(c.attr("data-pg"));break;case "open-book":a.REF.$bookContainer.removeClass(a.CLS.transparent);a.REF.$bookContent.attr("data-idx",c.attr("data-idx")).attr("data-start","0").attr("data-end","0").attr("data-pg","0").html("");a.REF.$bookPageNum.html("");case "book-nav":e=parseInt(a.REF.$bookContent.attr("data-idx"),10);if(isNaN(e)||0>=e)break;if(c="prev"!==c.attr("data-nav")){if("1"===a.REF.$bookContent.attr("data-eof")){alert("\u5df2\u8fbe\u672b\u9875");
break}}else{var i=parseInt(a.REF.$bookContent.attr("data-pg"),10);if(isNaN(i)||1>=i){alert("\u5df2\u8fbe\u9996\u9875");break}}i=a.REF.$bookContent.attr("data-"+(c?"end":"start"));if(!/^[0-9A-Fa-f]+$/.test(i))break;q(e,i,c);break;default:return}b.preventDefault();b.stopPropagation()}}});if(a.ENV.IS_EMBEDED)try{alloy.window.setBodySize({width:f.CFG.WIDTH,height:f.CFG.HEIGHT});alloy.window.setTitle({title:f.CFG.NAME});alloy.window.setButton({hasMaxButton:false,hasFullButton:false});alloy.window.setExitConfirm({msg:"\u662f\u5426\u786e\u5b9a\u8981\u9000\u51fa\u672c\u5e94\u7528\uff1f"})}catch(d){}a.REF.$DOC.bind("contextmenu",
function(b){b.preventDefault()});a.ENV.IS_IE&&a.REF.$DOC.bind("selectstart",function(b){"input"!==b.target.tagName.toLowerCase()&&b.preventDefault()})};f.init=function(d){f.CFG=h.extend({},f.CFG,d);a.REF.$DOC.ready(r)}})(window,document,DEMO,jQuery);
